#!/usr/bin/env bash
# This script configures Nginx to run as the nginx user and listen on port 8080

# Ensure the script is run as root
if [ "$EUID" -ne 0 ]; then
  echo "Please run as root or use sudo."
  exit 1
fi

# Ensure the nginx user exists
if ! id -u nginx >/dev/null 2>&1; then
  echo "Creating nginx user..."
  useradd -r nginx
fi

# Update the Nginx configuration file
NGINX_CONF="/etc/nginx/nginx.conf"

if [ -f "$NGINX_CONF" ]; then
  # Update the user directive to nginx
  sed -i 's/^user .*/user nginx;/' "$NGINX_CONF"

  # Change the listening port to 8080
  sed -i 's/listen 80;/listen 8080;/' "$NGINX_CONF"

  echo "Nginx configuration updated."
else
  echo "Nginx configuration file not found!"
  exit 1
fi

# Restart the Nginx service
echo "Restarting Nginx service..."
service nginx restart

# Verify the changes
echo "Verifying Nginx process and port..."
pgrep -a nginx
netstat -anp | grep ":8080"
